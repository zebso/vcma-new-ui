<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>オフラインです</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #000;
      color: #fff;
      padding: 20px;
    }
    .container {
      max-width: 480px;
      width: 100%;
    }
    .status {
      width: 64px;
      height: 64px;
      border: 2px solid #fff;
      border-radius: 50%;
      margin: 0 auto 48px;
      position: relative;
      animation: pulse 2s ease-in-out infinite;
    }
    .status::before,
    .status::after {
      content: '';
      position: absolute;
      background: #fff;
      border-radius: 2px;
    }
    .status::before {
      width: 2px;
      height: 24px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .status::after {
      width: 24px;
      height: 2px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    h1 {
      font-size: 32px;
      font-weight: 300;
      letter-spacing: -0.5px;
      margin-bottom: 16px;
      text-align: center;
    }
    p {
      font-size: 15px;
      line-height: 1.6;
      color: #a0a0a0;
      text-align: center;
      margin-bottom: 40px;
    }
    .link {
      display: inline-block;
      color: #fff;
      text-decoration: none;
      font-size: 14px;
      padding: 12px 32px;
      border: 1px solid #fff;
      border-radius: 4px;
      transition: all 0.2s ease;
      letter-spacing: 0.5px;
    }
    .link:hover {
      background: #fff;
      color: #000;
    }
    .link-container {
      text-align: center;
    }
  </style>
</head>
<body>
  <main class="container">
    <div class="status"></div>
    <h1>オフライン</h1>
    <p>ネットワーク接続をご確認ください。接続が復帰したら、下のボタンを押してください。</p>
    <div class="link-container">
      <a href="/dealer?source=pwa" class="link" id="retryLink">再読み込み</a>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const link = document.getElementById('retryLink');
      if (!link) return;

      link.href = '/dealer?retry=' + Date.now();
      
      link.addEventListener('click', function(event) {
          event.preventDefault(); 
          
          const mainPageUrl = '/dealer'; 
          
          if (navigator.onLine) {
              if ('serviceWorker' in navigator) {
                  link.textContent = '解除中...';
                  navigator.serviceWorker.getRegistrations().then(function(registrations) {
                      let unregisterPromises = [];
                      registrations.forEach(function(registration) {
                          unregisterPromises.push(registration.unregister());
                      });
                      
                      Promise.all(unregisterPromises).then(function() {
                          console.log('Service Worker unregistered. Forcing reload...');
                          window.location.replace(mainPageUrl + '?retry=' + Date.now());
                      }).catch(function(error) {
                          console.error('Service Worker unregistration failed:', error);
                          window.location.replace(mainPageUrl + '?retry=' + Date.now());
                      });
                  });
              } else {
                  window.location.replace(mainPageUrl + '?retry=' + Date.now());
              }
          } else {
              link.textContent = '接続を確認中です...';
              setTimeout(function() {
                  window.location.replace(mainPageUrl + '?retry=' + Date.now());
              }, 1000);
          }
      });
    });
  </script>
</body>
</html>